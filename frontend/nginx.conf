server {
    listen 443 ssl http2 default_server;
    # можно оставить IP, но для IP SNI не нужен; всё равно этот сервер — default_server
    server_name 144.31.193.121;

    # фронтовой сертификат (fullchain + privkey)
    ssl_certificate     /etc/nginx/certs/frontend.crt;
    ssl_certificate_key /etc/nginx/certs/frontend.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # статика SPA
    root /usr/share/nginx/html;
    index index.html;

    # SPA-роутинг
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ───────── доверие к внутреннему CA для HTTPS до сервисов ─────────
    # (этот файл положим в образ; см. Dockerfile)
    proxy_ssl_trusted_certificate /etc/nginx/certs/rootCA.crt;
    proxy_ssl_verify on;
    proxy_ssl_verify_depth 2;

    # общие заголовки для прокси
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;

    # ───────── first-service (Payara, порт 8443) ─────────
    location /first-service/ {
        proxy_ssl_server_name on;
        proxy_ssl_name first-service;     # SAN=DNS:first-service в его сертификате
        proxy_pass https://first-service:8443/;
    }

    # ───────── second-service (WildFly, порт 8443) ─────────
    location /second-service/ {
        proxy_ssl_server_name on;
        proxy_ssl_name second-service;    # SAN=DNS:second-service
        proxy_pass https://second-service:8443/;
    }
}
